# Kart Mania – Developer Notes

This file is the on-ramp for anyone picking up the project. It covers how to build, what each screen does, how assets flow through GRIT, and where settings/audio/live data live.

## Build and Run
- Requires devkitARM/libnds/maxmod (set `DEVKITARM` in your env). Makefile uses `$(DEVKITARM)/ds_rules`.
- Build: `make` (outputs `kart-mania.nds` in repo root; intermediates in `build/`). `make clean` removes outputs.
- Assets are auto-converted: GRIT for images (PNG + matching `.grit`), `mmutil` for audio.

## Runtime Overview
- Entry: `source/main.c`.
  - Storage: `Storage_Init()` (fatInitDefault, creates `/kart-mania`, seeds defaults) then `Storage_LoadSettings()` to overwrite defaults when SD/FAT is available.
  - Context: `GameContext_InitDefaults()` (wifi/music/sfx start true; state = `HOME_PAGE`).
  - Audio: `initSoundLibrary()`, `LoadALLSoundFX()`, `loadMUSIC()`, then `GameContext_SetMusicEnabled()` to start/stop based on loaded settings.
  - State loop: call `update_state` → if state changes, update `ctx->currentGameState`, call `video_nuke()` (clears VRAM/palettes/OAM/regs), then `init_state` for the new screen. `swiWaitForVBlank()` each frame.
  - State dispatch: `HOME_PAGE` → `HomePage_update`; `SETTINGS` → `Settings_update`; `SINGLEPLAYER` → `Singleplayer_update`; `MULTIPLAYER` currently reuses `HomePage_update` as a placeholder.

## Storage (SD/FAT)
- Files live under `/kart-mania` on the card:
  - `settings.txt` (authoritative) and `default_settings.txt` (seed) in plain text with `wifi=1/0`, `music=1/0`, `soundfx=1/0`.
- `storage.c/.h`:
  - `Storage_Init` mounts FAT, creates dir/files, seeds defaults.
  - `Storage_LoadSettings` pulls values into `GameContext` (no side effects; main later applies music/FX toggles).
  - `Storage_SaveSettings` writes current context; `Storage_ResetToDefaults` rewrites defaults then reloads.

## Audio
- Library: maxmod (`soundbank_bin`, `soundbank.h` generated by `mmutil` from `audio/CLICK.wav`, `audio/DING.wav`, `audio/tropical.xm`).
- SFX: `LoadALLSoundFX`/`UnloadALLSoundFX`; playback via `PlayCLICKSFX` / `PlayDingSFX`. Volume gated by `SOUNDFX_ON/OFF` (0 or 1024).
- Music: `loadMUSIC` loads module; `MusicSetEnabled` starts/stops looping at `MUSIC_VOLUME` (256). `GameContext_SetMusicEnabled` wires the toggle.

## Screen Breakdown (graphics + input)

### Home Page (`home_page.c/.h`)
- **Main screen (top)**: MODE_5_2D, BG2 bitmap from `data/home_top.png` on VRAM A (`BG_BMP_BASE(0)`). Affine registers identity. Kart sprite on VRAM B (main sprites), 1D mapping 32-byte boundaries, size 64×64, 256-color, palette `kart_homePal` → `SPRITE_PALETTE`, tiles → OAM gfx slot 0. Starts at (x=-64, y=120); moves +1 px per VBlank, wrapping to -64 after x>256 via IRQ VBlank (`initTimer` → `timerISRVblank` → `move_homeKart`).
- **Sub screen (bottom)**: MODE_0_2D on VRAM C with BG0 (menu) + BG1 (highlight).
  - BG0: `ds_menu` tiles/map/palette, `BG_MAP_BASE(0)`, `BG_TILE_BASE(1)`, `BG_COLOR_256`, priority 0.
  - BG1: highlight masks, `BG_MAP_BASE(1)`, `BG_TILE_BASE(2)`, `BG_COLOR_256`, priority 1. Palette slots 251–253 start black; tiles 1–3 are flat-color masks. Rectangles drawn at x=6..25, y rows 4/10/17 (height 3) for the three menu rows.
  - Menu hitboxes (touch): x=32 width=192 height=40; y = 24 + 54·row (rows 0–2).
- **Input**: D-pad up/down cycles selection (mod 3); touch selects by hitbox. On release (`KEY_A` or touch), plays click and returns `SINGLEPLAYER`, `MULTIPLAYER` (placeholder), or `SETTINGS`.

### Settings (`settings.c/.h`)
- **Main screen (top)**: MODE_5_2D, BG2 bitmap `data/settings_top.png` on VRAM A (`BG_BMP_BASE(0)`), identity affine.
- **Sub screen (bottom)**: MODE_0_2D on VRAM C with BG0 (UI art) + BG1 (toggles + highlight).
  - BG0: `nds_settings` tiles/map/palette, `BG_MAP_BASE(0)`, `BG_TILE_BASE(1)`, priority 0.
  - BG1: `BG_MAP_BASE(1)`, `BG_TILE_BASE(2)`, priority 1. Palette 254 = red (`TOGGLE_OFF_COLOR`), 255 = green (`TOGGLE_ON_COLOR`); palette 244–249 reserved for selection highlight (start black).
  - Toggle pills drawn at cols 21–29; rows wifi 1–4, music 5–8, sound fx 9–12 using tile 3 (red) or 4 (green) based on `GameContext`.
  - Selection rectangles: wifi (x 2–7, y 1–4), music (x 2–9, y 5–8), sound fx (x 2–13, y 9–12), save (x 4–14, y 15–23), back (x 12–20, y 15–23), home (x 20–28, y 15–23). Active selection sets palette slot 244 + button to `SETTINGS_SELECT_COLOR`.
- **Input**:
  - Touch bounds: wifi text (px 24–52, py 11–24) or pill (px 176–239, py 11–36); music text (px 25–68, py 41–54) or pill (px 176–239, py 41–66); sound fx text (px 24–98, py 71–84) or pill (px 176–239, py 71–96); save/back/home circles roughly px 41–87 / 105–151 / 169–215 with py 129–175.
  - D-pad up/down cycles items; left/right wraps bottom row (save ↔ back ↔ home).
  - On release (`KEY_A` or touch): toggles wifi/music/sfx (updates context, redraws pill, plays ding; ding plays before muting when toggling off SFX), save calls stub `onSavePressed` + ding (wire to `Storage_SaveSettings` later), back/home play click and return `HOME_PAGE`.

### Singleplayer Map Select (`game.c/.h`)
- **Main screen (top)**: MODE_5_2D, BG2 bitmap `data/map_top.png` on VRAM A (`BG_BMP_BASE(0)`), identity affine.
- **Sub screen (bottom)**: MODE_0_2D on VRAM C with BG0 (maps UI) + BG1 (selection overlay).
  - BG0: `map_bottom` tiles/map/palette, `BG_MAP_BASE(0)`, `BG_TILE_BASE(1)`, priority 0.
  - BG1: `BG_MAP_BASE(1)`, `BG_TILE_BASE(3)`, priority 1. Palette slots 240–243 hold highlight color per button (start black); tiles 0–3 are flat-color masks.
  - Selection rectangles: Map1 x=2–11, y=9–20; Map2 x=11–20, y=9–20; Map3 x=20–29, y=9–20; Home x=28–31, y=20–23. Palette slot 240 + button set to `SP_SELECT_COLOR` when active.
- **Input**: Touch bounds Map1 px 20–80 py 70–165; Map2 98–158 70–165; Map3 176–236 70–165; Home 224–251 161–188. D-pad up/down cycles; left/right steps map1→map2→map3→home with wrap. On release (`KEY_A` or touch): maps play click (TODO: load map), home plays click and returns `HOME_PAGE`.

## Graphics Reset
- `video_nuke` (graphics.c) is called on state changes: blanks main/sub displays, clears OAM, palettes, VRAM A/B/C, resets BG control, offsets, and affine registers to known defaults before reconfiguring the next screen.

## Assets and Conversion Workflow
- Source images in `data/` must have matching `.grit` files (same basename) to be built. Current art: `ds_menu`, `home_top`, `kart_home`, `map_bottom`, `map_top`, `nds_settings`, `settings_top`.
- macOS GRIT channel swap: `R_B_IMAGE_CONVERTER/convert.py` swaps red/blue before GRIT. Use when a PNG was authored on macOS to avoid inverted colors.
  - Usage: `python3 R_B_IMAGE_CONVERTER/convert.py input.png output.png` then feed `output.png` to GRIT.
- GRIT commands (examples used here):
  - Backgrounds: `grit ds_menu.png -g -gB8 -gb -p` (8-bit bitmap + palette). Makefile has a special-case palette tweak for `ds_menu.s` (`.hword 0x7C1F` → `.hword 0x7BBD`).
  - Button sprites (legacy generator): `grit button.png -g -gB8 -gTFF00FF -gt` (8-bit with magenta transparency).
- Audio: place `.wav`/`.xm` in `audio/`; `mmutil $^ -osoundbank.bin -hsoundbank.h -d` (see Makefile rule) regenerates soundbank on build.

## File Map (key sources)
- Core loop/state: `source/main.c`, `source/game_types.h`.
- Context/settings: `source/context.c/.h`, `source/settings.c/.h`, `source/storage.c/.h`.
- Home: `source/home_page.c/.h`, `source/timer.c/.h`.
- Singleplayer select: `source/game.c/.h`.
- Graphics utilities: `source/graphics.c/.h`, colors `source/color.h`.
- Audio: `source/sound.c/.h`, assets in `audio/`.
- Art sources: `data/` PNG + `.grit`; channel fixer `R_B_IMAGE_CONVERTER/convert.py`.
